---
title: "gsbe-data-prep"
author: "bbl"
format:
  html:
    code-fold: true
toc: true
editor: visual
---

```{r setup}
#| include: false

library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_bw())
library(sf)
library(rnaturalearth)
library(readr)
library(terra)
library(lubridate)
```

## SRDB

```{r read-srdb}
#| fig-width: 12

read_csv("data-srdb/srdb-data.csv", show_col_types = FALSE) %>% 
    select(Author, Study_midyear, YearsOfData, 
           Latitude, Longitude, Elevation, Manipulation, 
           Biome, Ecosystem_type, Ecosystem_state, 
           Rs_annual, Rs_growingseason) %>% 
    filter(!is.na(Longitude), !is.na(Latitude), !is.na(Study_midyear)) %>% 
    filter(!is.na(Rs_growingseason) | !is.na(Rs_annual)) %>% 
    filter(Manipulation == "None") %>% 
    mutate(Longitude = round(Longitude, 3),
           Latitude = round(Latitude, 3)) ->
    srdb

message(nrow(srdb), " rows of data")

message("There are ", sum(srdb$YearsOfData > 1, na.rm = TRUE), " multi-year observations")

srdb %>% 
    filter(YearsOfData == 1) ->
    srdb
message(nrow(srdb), " final rows of data")

world <- ne_coastline()
srdb_annual <- srdb %>% filter(is.na(Rs_annual))
ggplot(world) + 
    geom_sf() + 
    geom_point(data = srdb_annual, 
               aes(x = Longitude, y = Latitude, color = Biome),
               na.rm = TRUE) + 
    ggtitle(paste0("SRDB Rs_annual N=", nrow(srdb_annual)))

srdb_growingseason <- srdb %>% filter(is.na(Rs_growingseason))
ggplot(world) + 
    geom_sf() + 
    geom_point(data = srdb_growingseason, 
               aes(x = Longitude, y = Latitude, color = Biome),
               na.rm = TRUE) + 
    ggtitle(paste0("SRDB Rs_growingseason N=", nrow(srdb_growingseason)))
```

```{r srdb-prep}
#| fig-width: 12

set.seed(12)
srdb %>% 
    slice_sample(n = 20) -> 
    srdb_sample

srdb_sample %>% 
    select(Longitude, Latitude) ->
    coords

ggplot(world) + 
    geom_sf() + 
    geom_point(data = srdb_sample, 
               aes(x = Longitude, y = Latitude, color = Biome),
               size = 4,
               na.rm = TRUE) + 
    ggtitle(paste0("SRDB subsample N=", nrow(srdb_sample)))
```

## SPEI

We are using the ERA5â€“Drought dataset; see Keune et al. 2025 <https://www.nature.com/articles/s41597-025-04896-y>.

```{r read-spei}
#| fig-height: 6
#| fig-width: 10

files <- list.files(path = "data-spei/", pattern = "*.nc$", full.names = TRUE)
message("Processing ", length(files), " SPEI files...")
spei_list <- list()
for(f in files) {
    x <- suppressWarnings(terra::rast(f)) 
    dat <- terra::extract(x, coords)
    dat$time <- terra::time(x)
    spei_list[[f]] <- dat
}
bind_rows(spei_list) %>% 
    as_tibble() -> spei
spei$Biome <- srdb_sample$Biome[spei$ID]

ggplot(spei, aes(x = SPEI12)) +
    geom_histogram(bins = 50) + 
    facet_wrap(~Biome) +
    ggtitle("SPEI12")

ggplot(spei, aes(time, SPEI12, color = Biome, group = ID)) + 
    geom_line() + 
    facet_grid(Biome~.) + 
    theme(legend.position = "none") +
    ggtitle("SPEI12")

# Summarise to annual, January-March, and July-September
spei %>% 
    mutate(Year = year(time), 
           Month = month(time)) %>% 
    arrange(time) %>% 
    group_by(Biome, ID, Year) %>% 
    summarise(SPEI12jja = mean(SPEI12[7:9]),
              SPEI12jfm = mean(SPEI12[1:3]),
              SPEI12 = mean(SPEI12),
              .groups = "drop") ->
    spei_annual

ggplot(spei_annual, aes(Year, SPEI12, color = Biome, group = ID)) + 
    geom_line() + 
    facet_grid(Biome~.) + 
    theme(legend.position = "none") +
    ggtitle("SPEI12 - annual mean")

ggplot(spei_annual, aes(Year, SPEI12jja, color = Biome, group = ID)) + 
    geom_line() + 
    facet_grid(Biome~.) + 
    theme(legend.position = "none") +
    ggtitle("SPEI12 - jja")

message("Merging into SRDB data...")
srdb_sample$ID <- seq_len(nrow(srdb_sample))
srdb_sample$Year <- floor(srdb_sample$Study_midyear)
srdb_sample$Year1 <- srdb_sample$Year - 1

spei_annual %>% select(ID, Year, SPEI12) -> spei_annual_join
spei_annual_join %>% rename(SPEI12_y1 = SPEI12) -> spei_annual_join_y1

srdb_sample %>% 
    left_join(spei_annual_join, by = c("ID" = "ID", "Year" = "Year")) %>% 
    left_join(spei_annual_join_y1, by = c("ID" = "ID", "Year1" = "Year")) ->
    srdb_sample

ggplot(srdb_sample, aes(x = SPEI12_y1)) + 
    geom_histogram(bins = 50) + 
    geom_vline(xintercept = -0.84, linetype = 2, color = "red") +
    geom_vline(xintercept = -1.28, linetype = 2, color = "red") +
    geom_vline(xintercept = -1.65, linetype = 2, color = "red") +
    facet_wrap(~Biome) +
    ggtitle("SPEI12 previous year", 
            subtitle = "Dashed lines show SPEI categories for mild, moderate, severe dryness")

ggplot(srdb_sample, aes(Year, SPEI12_y1, color = Biome)) + 
    geom_point() + 
    facet_grid(Biome~.) + 
    theme(legend.position = "none") +
    ggtitle("SPEI12 previous year")
```

## Climate data

Ugh, the ERA5 data are *big* and operations are *slow*. I'm not a GIS expert, so spent a while playing around with `terra::crop()`, `raster::aggregate()`, etc., with little success.

We use two strategies to deal with this:

-   Download individual-year `grib` files from the EMCWF Climate Data Store (a pain to download, but then extracting from them is relatively fast); and

-   Use a cache so we only process things once, hopefully

```{r read-era5}
#| fig-height: 6
#| fig-width: 10

ERA5_SHORT_NAME <- read_csv("ERA5_short_names.csv", col_types = "cc")
ERA5_CACHE <- "ERA5_data_cache.csv"
if(file.exists(ERA5_CACHE)) {
    cache <- read_csv(ERA5_CACHE, col_types = "dddTcd")    
} else {
    message("No ERA5 data cache found")
    cache <- tibble(Year = numeric(0), Longitude = numeric(0), Latitude = numeric(0))
}

srdb_sample %>% 
    distinct(Year, Longitude, Latitude) ->
    srdb_yrlonlat

for(i in seq_len(nrow(srdb_yrlonlat))) {
    yr <- srdb_yrlonlat$Year[i]
    lon <- srdb_yrlonlat$Longitude[i]
    lat <- srdb_yrlonlat$Latitude[i]
    message(yr, " ", lon, " ", lat)
    
    # Are data already in cache?
    cache %>% 
        filter(Year == yr, Longitude == lon, Latitude == lat) ->
        dat
    if(nrow(dat) > 0) {
        message("\t", nrow(dat), " data rows are in cache")
    } else {
        # Construct year-specific file name; these were downloaded from ECMWF
        # and contain 2m temperature, soil temperature levels 1 and 2, 
        # volumetric soil water content levels 1 and 2, total precipitation,
        # and LAI of high vegetation
        f <- file.path("data-ERA5/", paste0("ERA5_", yr, ".grib"))
        if(!file.exists(f)) {
            message("\t", f, " does not exist; skipping")
            next
        }
        message("\tNo data in cache; extracting from ", f, "...")
        x <- terra::rast(f)
        
        # Make sure the time period is what we're expecting
        if(!all(year(time(x)) == yr)) {
            stop("Year is supposed to be ", yr, " but file data dates are different!")
        }
        
        # Extract, reshape, clean up
        y <- terra::extract(x, srdb_yrlonlat[i,][-1])
        y %>% 
            pivot_longer(-ID) %>% 
            mutate(time = time(x), Year = yr, Longitude = lon, Latitude = lat) %>% 
            left_join(ERA5_SHORT_NAME, by = "name") %>% 
            select(Year, time, Longitude, Latitude, short_name, value) ->
            dat
        cache <- bind_rows(cache, dat)
        message("\tAdding ", nrow(dat), " data rows to cache...")
        write_csv(cache, ERA5_CACHE)
    }    
}


```

## Soil type data

```{r read-soil-types}
#| warning: false
#| fig-width: 12

# Extract for SRDB points
x <- rast("data-ERA5/ERA5_soil_type.grib")
plot(x)
y <- terra::extract(x, coords)
names(y) <- c("ID", "Soil_type_number")

# Attach names to numeric codes
y$Soil_type_number <- as.character(y$Soil_type_number) # for join below
soil_names <- tibble(strings = strsplit(units(x), "; ")[[1]]) %>% 
    separate(strings, into = c("Soil_type_number", "Soil_type_name"), convert = TRUE, sep = "=")
y <- y %>% left_join(soil_names, by = "Soil_type_number")

srdb_sample <- bind_cols(srdb_sample, y[-1])
```

## Reproducibility

```{r}
#| echo: false

sessionInfo()
```
