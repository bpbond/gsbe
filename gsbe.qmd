---
title: "gsbe-data"
author: "bbl"
format:
  html:
    code-fold: true
toc: true
editor: visual
---

```{r setup}
#| include: false

library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_bw())
library(readr)
library(lubridate)

dat <- read_csv("srdb_joined_data.csv", show_col_types = FALSE)

message(nrow(dat), " rows of data")

dat %>% 
    filter(is.na(Rs_growingseason) | (Rs_growingseason > 0 & Rs_growingseason < 20)) %>% 
    filter(is.na(Rs_annual) | (Rs_annual > 0 & Rs_annual < 4000)) %>% 
    filter(is.na(Rh_annual) | (Rh_annual > 0 & Rh_annual < 2000)) %>% 
    replace_na(list(Biome = "Unknown")) ->
    dat_filtered

```

## Independent variable distribution

We have three potential independent variables – `Rs_annual` (annual soil respiration), `Rh_annual` (annual heterotrophic respiration), and `Rs_growingseason` (mean growing season soil respiration) – and expect their distributions to be non-normal.

```{r}
#| fig-width: 10
#| fig-height: 8

dat_filtered %>% 
    select(Rs_annual, Rh_annual, Rs_growingseason) %>% 
    pivot_longer(everything()) %>% 
    filter(!is.na(value), value > 0) %>% 
    rename(none = value) %>% 
    mutate(log = log(none), sqrt = sqrt(none)) %>% 
    
    pivot_longer(-name, names_to = "Transformation") %>% 
    ggplot(aes(value, color = Transformation)) + 
    geom_density() +
    facet_wrap(~ name + Transformation, scales = "free")

dat_filtered %>% 
    mutate(sqrt_Rs_annual = sqrt(Rs_annual),
           sqrt_Rh_annual = sqrt(Rh_annual),
           sqrt_Rs_growingseason = sqrt(Rs_growingseason)) ->
    dat_filtered

```

We have a winner: `sqrt()`!

## Dataset overview

```{r read-data}
#| fig-width: 10
#| fig-height: 8

dat_filtered %>% 
    select(Biome, Ecosystem_type, sqrt_Rs_annual, sqrt_Rh_annual, sqrt_Rs_growingseason,
           Tair, Tsoil_lev1, VWC_lev1, Precip, LAI_high, 
           MODIS_NPP, MODIS_GPP) %>% 
    pivot_longer(Tair:MODIS_GPP, names_to = "covariate_name", values_to = "covariate_value") %>%
    pivot_longer(sqrt_Rs_annual:sqrt_Rs_growingseason) %>% 
    ggplot(aes(value, covariate_value, color = Biome)) + 
        facet_grid(covariate_name ~ name, scales = "free") +
        geom_point(na.rm = TRUE)

dat_filtered %>% 
    filter(!Biome == "Semi-arid", !Biome == "Unknown") %>% 
    select(Biome, Ecosystem_type, sqrt_Rs_annual, 
           Tair, Tsoil_lev1, VWC_lev1, Precip, LAI_high) %>% 
    pivot_longer(Tair:LAI_high, names_to = "covariate_name", values_to = "covariate_value") %>% 
    ggplot(aes(sqrt_Rs_annual, covariate_value, color = Biome)) + 
        facet_grid(covariate_name ~ Biome, scales = "free") +
        geom_point(na.rm = TRUE)
 
stn <- as.factor(dat_filtered$Soil_type_number)
nst <- length(unique(stn))
dat_filtered %>% 
    select(sqrt_Rs_growingseason, sqrt_Rs_annual, sqrt_Rh_annual) %>% 
    pairs(col = hcl.colors(nst, "Temps")[stn])

```

## Analysis1

```{r}
#| eval: false


fit_lm <- function(x) {} # fit linear model for a dataset; i.v. in first column
fit_rf <- function(x) {} # fit random forest model

do_k_fold <- function(x, k = 10) {} # compute fit statistics using k-fold

# loop k times
# assign training/validation

# compute distances between points if using spatial RF
# fit ranger::ranger() or spatialRF::rf()
# predict and compute R2

# fit_lm()
# predict and compute R2

# return fit statistics by model type

do_full_analysis <- function(x, iv_set, spei_cutoff_values) {}
# rescale predictors
# complete.cases
# compute variable inflation or other correlated predictors metric

# loop over iv_set and spei_cutoff_values:

# - compute PBE flag
    dat_filtered %>% 
        # identify observations not in a drought but WERE in a drought
        # PBE = potential Birch effect
        mutate(PBE = SPEI12 > 0 & SPEI12_y1 <= -1) ->
        dat_pbe
# - for each model type
# --- fit model and calculate PBE effect
# --- call do_k_fold
# --- save fit data associated with this iv and cutoff value

m <- lm(sqrt_Rs_annual ~ Tair + Tsoil_lev1 + Tsoil_lev2 + 
            VWC_lev1 + I(VWC_lev1 ^ 2) + VWC_lev2 ^ 2 + I(VWC_lev2 ^ 2) + 
            MODIS_GPP + MODIS_NPP + 
            Ecosystem_type * PBE, 
        data = dat_pbe)
summary(m)

m_reduced <- MASS::stepAIC(m)
summary(m_reduced)
library(car)
car::Anova(m_reduced, type = "III")
```

## Reproducibility

```{r}
#| echo: false

sessionInfo()
```

