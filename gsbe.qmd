---
title: "gsbe-data"
author: "bbl"
format:
  html:
    code-fold: true
toc: true
editor: visual
---

```{r setup}
#| include: false

library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_bw())
library(readr)
library(lubridate)
```

## Dataset overview

```{r read-data}
#| fig-width: 10
#| fig-height: 10

dat <- read_csv("srdb_joined_data.csv", show_col_types = FALSE)

message(nrow(dat), " rows of data")

dat %>% 
    filter(is.na(Rs_growingseason) | Rs_growingseason < 20) %>% 
    filter(is.na(Rs_annual) | Rs_annual < 4000) %>% 
    filter(is.na(Rh_annual) | Rh_annual < 2000) %>% 
    replace_na(list(Biome = "Unknown")) ->
    dat_filtered

dat_filtered %>% 
    select(Biome, Ecosystem_type, Rs_annual, Rh_annual, Rs_growingseason,
           Tair, Tsoil_lev1, VWC_lev1, Precip, LAI_high, 
           MODIS_NPP, MODIS_GPP) %>% 
    pivot_longer(Tair:MODIS_GPP, names_to = "covariate_name", values_to = "covariate_value") %>%
    pivot_longer(Rs_annual:Rs_growingseason) %>% 
    ggplot(aes(value, covariate_value, color = Biome)) + 
        facet_grid(covariate_name ~ name, scales = "free") +
        geom_point(na.rm = TRUE)

dat_filtered %>% 
    filter(!Biome == "Semi-arid", !Biome == "Unknown") %>% 
    select(Biome, Ecosystem_type, Rs_annual, 
           Tair, Tsoil_lev1, VWC_lev1, Precip, LAI_high) %>% 
    pivot_longer(Tair:LAI_high, names_to = "covariate_name", values_to = "covariate_value") %>% 
    ggplot(aes(Rs_annual, covariate_value, color = Biome)) + 
        facet_grid(covariate_name ~ Biome, scales = "free") +
        geom_point(na.rm = TRUE)
 
stn <- as.factor(dat_filtered$Soil_type_number)
nst <- length(unique(stn))
dat_filtered %>% 
    select(Rs_growingseason, Rs_annual, Rh_annual) %>% 
    pairs(col = hcl.colors(nst, "Temps")[stn])

# Groups



```

## Independent variable distribution

```{r}
dat_filtered %>% 
    select(Rs_annual, Rh_annual, Rs_growingseason) %>% 
    pivot_longer(everything()) %>% 
    filter(!is.na(value), value > 0) %>% 
    rename(none = value) %>% 
    mutate(log = log(none), sqrt = sqrt(none)) %>% 
    
    pivot_longer(-name, names_to = "Transformation") %>% 
    ggplot(aes(value, color = Transformation)) + 
    geom_density() +
    facet_wrap(~ name + Transformation, scales = "free")

message("We have a winner: sqrt!")
```

## Analysis1

```{r}
#| eval: false

# Identify observations not in a drought but WERE in a drought
# PBE = potential Birch effect


run_analysis <- function(SPEI_boundary, x) {
    x %>% 
        mutate(PBE = SPEI12 > 0 & SPEI12_y1 <= -SPEI_boundary) ->
        dat_pbe
    
    # Compute PBE flag
    
    # complete cases
    
    # rescale predictors (do beforehand)
    
    # compute distances between points (do beforehand)
    
    # compute variable inflation or other correlated predictors metric
    
    # fit ranger::ranger() or spatialRF::rf()
    
}



m <- lm(sqrt(Rs_annual) ~ Tair + Tsoil_lev1 + Tsoil_lev2 + 
            VWC_lev1 + I(VWC_lev1 ^ 2) + VWC_lev2 ^ 2 + I(VWC_lev2 ^ 2) + 
            MODIS_GPP + MODIS_NPP + 
            Ecosystem_type * PBE, 
        data = dat_pbe)
summary(m)

m_reduced <- MASS::stepAIC(m)
summary(m_reduced)
library(car)
car::Anova(m_reduced, type = "III")
```

## Reproducibility

```{r}
#| echo: false

sessionInfo()
```
